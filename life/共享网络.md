## 一个网口那些事

```
linux双网口
linuu双网口流量转发
linux双网口实现网络共享
```



### 背景

​	最近`fnos`很火（一个`nas`系统），正巧手上有一台不用的电脑，索性安装、运行、nas启动。随后就遇到了一个问题，出租屋只有一个网口，nas用了这个网口，我打游戏的电脑怎么办呢？幸亏这台闲置电脑有2个网口。

​	好的，我们轻点一下手头的物资。2台计算机（1台linux 双网口，1台windows单网口），1个连接外网的网口，网线可以在公司拿，所以是无数条（开个玩笑，我只拿了3条，其实只需要两条）

### 网络共享

##### 1 检查现有的网络设备

先找出连接外网的网卡，以及暂时没启用的网卡

```bash
nmcli device status
```

假设：eth0 连接有线网口，eth1 连接内网windows主机

##### 2 配置内网接口（eth1）静态IP地址

```bash
nmcli con add type ethernet con-name internal ifname eth1 ip4 192.168.1.1/24
nmcli con up internal
```

这会将 eth1 配置为具有IP地址 192.168.1.1 和子网掩码 255.255.255.0。

命令解释（只是一个注解，你无需掌握）：

​	1.	nmcli con add：创建一个新的连接。

​	2.	type ethernet：指定连接类型为以太网（Ethernet）。

​	3.	con-name internal：为连接命名为 internal，你可以用它来标识或管理该连接。

​	4.	ifname eth1：指定网络接口 eth1，这是这个连接要应用的接口。

​	5.	ip4 192.168.1.1/24：为该接口分配一个 IPv4 地址 192.168.1.1，子网掩码为 255.255.255.0，也就是 /24。

> 注意：这里的ip地址可以理解为路由器网关，如果外部路由器网关（连接外网的网口）的ip已经是192.168.1.1 ，要改为其他地址，避免ip冲突
>
> 例：192.168.2.1/24

##### 3 启用ip转发

编辑 /etc/sysctl.conf 文件，找到并取消注释或者添加以下行：

```bash
net.ipv4.ip_forward=1
```

然后执行以下命令以应用更改：

```bash
sudo sysctl -p
```

第二条命令是为了刷新网络配置

##### 4 设置NAT转发

使用 iptables 配置NAT，让内网的Windows电脑通过Debian的外网接口访问网络。

```bash
sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
```

##### 5 保存iptables规则

如果只是临时启用可以不持久化

安装 iptables-persistent，以便重启后规则依然有效：

```bash
sudo apt install iptables-persistent
sudo netfilter-persistent save
```

此时网络共享已经完成，但是被共享的windows电脑并不能自动获取ip等信息，需要我们手动配置

##### 6 配置windows电脑网络

打开设置 -> 网络状态 -> 更改适配器选项

找到windows电脑的网卡（网络状态页面最上方XXX专用网络，或以太网），`右键属性`

在`连接使用下列项目` 中找到 `Internet 协议版本4（TCP/IPv4` 双击使用下方ip地址，配置如下

在Windows电脑上，手动配置网络接口的IP地址：

​	•	**IP地址**：192.168.1.2 (这里的ip要和第2步设置的网关是同一个网段)

​	•	**子网掩码**：255.255.255.0

​	•	**默认网关**：192.168.2.1（即Linux机器的eth1 IP地址）

​	•	**DNS服务器**：使用公共DNS服务器，例如 8.8.8.8（Google DNS），或者使用你外网路由器的DNS设置。

点击确定，完成。

此时即可打开浏览器打开B站刷视频了。